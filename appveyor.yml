version: 0.1.{build}
branches:
  # whitelist
  only:
    - master
skip_tags: true
test:
  assemblies:
    - Snowflake.Test.dll
configuration: Debug
build:
  project: Snowflake.sln
environment:
    COVERALLS_REPO_TOKEN:
      secure: nBi3LwnqgslaH8hbsvjnWTqpe/UbKn705TJujxqJwtcL5OLGfcydM8AnVyld6Ngu
    MYGET_API_KEY:
      secure: c0TSni4oM3D75P31isNFRu0z4whPsrvTAcu67iLlFmtvvrzopEI8Xj5qWk1pwMkj
install:
    - choco install doxygen.portable
    - nuget restore
after_build:
    - echo Generating doxygen documentation
    - doxygen.exe "C:\projects\snowflake\snowflake.doxygen" 2> nul
after_test:
    - echo Generating Code Coverage Report
    - packages\OpenCover.4.5.3522\OpenCover.Console.exe -register:user -filter:"+[Snowflake*]*" -target:"packages/xunit.runners.2.0.0-rc1-build2826\tools\xunit.console.exe" -targetargs:"Snowflake.Tests\bin\%CONFIGURATION%\Snowflake.Tests.dll -noshadow" -output:coverage.xml
    - echo Uploading Code Coverage Report to Coveralls
    - packages\coveralls.io.1.1.86\tools\coveralls.net.exe --opencover coverage.xml
    - echo Packing NuGet packages
    - nuget pack Snowflake\Snowflake.csproj -IncludeReferencedProjects -Symbols
    - nuget pack Snowflake.API\Snowflake.API.csproj -IncludeReferencedProjects  -Symbols
    - cmd: |
        echo Uploading NuGet packages to MyGet snowflake-nightly feed
        nuget setApiKey %MYGET_API_KEY% -Source https://www.myget.org/F/snowflake-nightly/api/v2/package 2> nul
        nuget setApiKey %MYGET_API_KEY% -Source https://nuget.symbolsource.org/MyGet/snowflake-nightly 2> nul
        nuget push Snowflake.API.%APPVEYOR_BUILD_VERSION%-pre-alpha-nightly.nupkg -Source https://www.myget.org/F/snowflake-nightly/api/v2/package
        nuget push Snowflake.API.%APPVEYOR_BUILD_VERSION%-pre-alpha-nightly.Symbols.nupkg -Source https://nuget.symbolsource.org/MyGet/snowflake-nightly
        nuget push Snowflake.%APPVEYOR_BUILD_VERSION%-pre-alpha-nightly.nupkg -Source https://www.myget.org/F/snowflake-nightly/api/v2/package
        nuget push Snowflake.%APPVEYOR_BUILD_VERSION%-pre-alpha-nightly.Symbols.nupkg -Source https://nuget.symbolsource.org/MyGet/snowflake-nightly
        exit /b 0
artifacts:
    - path: Snowflake\bin\$(configuration)
      name: Snowflake Base Libraries
      type: zip
    - path: doc
      name: Generated documentation
      type: zip
assembly_info:
    patch: true
    file: SharedAssemblyInfo.cs
    assembly_version: '{version}'
    assembly_file_version: '{version}'
    assembly_informational_version: '{version}-pre-alpha-nightly'
